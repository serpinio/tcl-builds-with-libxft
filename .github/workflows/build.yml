name: Tcl/Tk Linux-Only Distribution

on:
  workflow_dispatch:
    inputs:
      tcl-versions:
        required: true
        type: choice
        options:
          - '["9.0.3"]'
        default: '["9.0.3"]'
      architectures:
        required: true
        type: choice
        options:
          - '["x64"]'
        default: '["x64"]'
      config:
        type: choice
        required: true
        options:
          - 'Tcl_BI'
        default: 'Tcl_BI'

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        architecture: ${{ fromJSON(github.event.inputs.architectures) }}
        tcl-version: ${{ fromJSON(github.event.inputs.tcl-versions) }}

    steps:
    - name: Setup BAWT environment
      run: |
       GH_BAWT_BUILDROOT="BawtBuild/${{ matrix.tcl-version }}/${{ github.event.inputs.config }}"
       GH_BAWT_BUILDDIR="$GH_BAWT_BUILDROOT/Linux/${{ matrix.architecture }}"
       echo "GH_BAWT_BUILDROOT=$GH_BAWT_BUILDROOT" >> $GITHUB_ENV
       echo "GH_BAWT_BUILDDIR=$GH_BAWT_BUILDDIR" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential curl p7zip-full zip \
          libx11-dev libcups2-dev libcairo2-dev libglx-dev \
          libglu1-mesa-dev libasound2-dev libxft-dev libfontconfig1-dev libxrender-dev

    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Download BAWT framework
      run: |
        curl -L -o Bawt-3.2.0.zip https://www.bawt.tcl3d.org/download/Framework/Bawt-3.2.0.zip
        unzip Bawt-3.2.0.zip

    - name: Set permissions
      run: |
        cd Bawt-3.2.0
        chmod u+x Build*.sh
        chmod u+x tclkit*

    - name: Patch BAWT legacy boot scripts
      run: |
        # Primary pass. replace files explicitly named boot.tcl
        find Bawt-3.2.0 -name "boot.tcl" -print -exec cp patches/boot-tcl9.tcl {} \;
        
        # Retool the Engine lol. inject Tcl 9 compatibility into Bawt.tcl
        # This IN THEORY should prevent the generator from writing legacy VFS strings into new kits
        cd Bawt-3.2.0
        echo "Injecting Tcl 9 compatibility into BAWT engine..."
        sed -i 's/vfs::mk4/vfs::zip/g' Bawt.tcl
        sed -i 's/vlerq get/zipfs list/g' Bawt.tcl
        
        # Target known template directory
        if [ -d "BawtAtWork/Templates" ]; then
            cp -v ../patches/boot-tcl9.tcl BawtAtWork/Templates/boot.tcl || true
            cp -v ../patches/boot-tcl9.tcl BawtAtWork/Templates/init.tcl || true
        fi

        # Modify internal VFS of all potential bootstrap/base kits
        # Locate the SDX entry point within the BAWT library structure
        # Im getting tired of this
        SDX_TCL=$(find . -name "sdx.tcl" | head -n 1)
        echo "Found SDX source at: $SDX_TCL"

        if [ -n "$SDX_TCL" ]; then
            for kit in tclkit-Linux64*; do
                if [ -f "$kit" ] && [ ! -d "$kit" ]; then
                    echo "Patching internal VFS of $kit..."
                    # Use the tclkit to run the SDX source directly to unwrap
                    ./tclkit-Linux64-intel "$SDX_TCL" unwrap "$kit" || true
                    
                    if [ -f "${kit}.vfs/boot.tcl" ]; then
                        cp -v ../patches/boot-tcl9.tcl "${kit}.vfs/boot.tcl"
                        # Rewrap the binary with patched boot script
                        ./tclkit-Linux64-intel "$SDX_TCL" wrap "$kit" -writable
                    fi
                    rm -rf "${kit}.vfs"
                fi
            done
        else
            echo "Warning: sdx.tcl not found, applying binary sed replacement as fallback"
            for kit in tclkit-Linux64*; do
                if [ -f "$kit" ]; then
                    sed -i 's/vfs::mk4/vfs::zip/g' "$kit" || true
                fi
            done
        fi
        cd ..

        # replace ONLY text files containing fingerprints
        # Specifically excluding the tclkit binaries to prevent overwriting executables
        grep -lR "vfs::mk4" Bawt-3.2.0 --exclude="tclkit*" | xargs -I {} sh -c 'if file "{}" | grep -q "text"; then cp -v patches/boot-tcl9.tcl "{}"; fi'
        grep -lR "vlerq get" Bawt-3.2.0 --exclude="tclkit*" | xargs -I {} sh -c 'if file "{}" | grep -q "text"; then cp -v patches/boot-tcl9.tcl "{}"; fi'

        echo "Successfully updated BAWT templates"

    - name: Build Tcl/Tk Distribution
      run: |
        echo GH_BAWT_BUILDROOT=$GH_BAWT_BUILDROOT
        Bawt-3.2.0/tclkit-Linux64-intel Bawt-3.2.0/Bawt.tcl --rootdir $GH_BAWT_BUILDROOT --architecture ${{ matrix.architecture }} --compiler gcc --numjobs 4 --complete --tclversion ${{ matrix.tcl-version }} --exclude ffmpeg ${{ github.event.inputs.config }}.bawt all

    - name: SCORCHED EARTH!!!
      run: |
        echo "Starting recursive surgery on distribution files"
        DIST_DIR="${{ env.GH_BAWT_BUILDDIR }}/Release/Distribution"
        
        # Force-patch EVERY text file that looks like a boot/init script
        # Find files containing 'proc tclInit'
        # Last try - check if the file is 'text' before using 'cp' to avoid corrupting ELF binaries
        find "$DIST_DIR" -type f -exec grep -l "proc tclInit" {} + | while read -r file; do
            if file "$file" | grep -q "text"; then
                echo "Surgery on script: $file"
                cp -v patches/boot-tcl9.tcl "$file"
            else
                echo "Found proc tclInit in binary, skipping overwrite to protect ELF header: $file"
            fi
        done

        # Aggressive String Replacement for text-based pkgIndex and support scripts
        find "$DIST_DIR" -type f -exec sed -i 's/vfs::mk4/vfs::zip/g' {} + 2>/dev/null || true
        find "$DIST_DIR" -type f -exec sed -i 's/vlerq get/zipfs list/g' {} + 2>/dev/null || true
        
        # Handle the binaries (tclkit)
        # Binary-safe sed replacement of the VFS driver name
        # Length 'vfs::mk4' == 'vfs::zip' (8 chars), preventing offset corruption
        echo "Performing binary surgery on tclkit executables..."
        find "$DIST_DIR" -name "tclkit*" -type f -exec sed -i 's/vfs::mk4/vfs::zip/g' {} +

    - name: Validate Build Artifacts
      run: |
        echo "Checking for legacy VFS fingerprints in ENTRY SCRIPTS ONLY..."
        # Focus on the boot logic that actually prevents Tcl 9 from starting.
        BAD_FOUND=$(grep -r "vfs::mk4" ${{ env.GH_BAWT_BUILDDIR }}/Release/Distribution --exclude-dir="vfs1.5.0" || true)
        
        if [ -n "$BAD_FOUND" ]; then
            echo "CRITICAL ERROR: Legacy code found in core scripts outside of driver libraries:"
            echo "$BAD_FOUND"
            exit 1
        else
            echo "SUCCESS: No legacy VFS fingerprints found in entry scripts. There's HOPE"
        fi

    - name: Upload distribution
      uses: actions/upload-artifact@v4
      with:
        name: tcl-distribution-linux-${{ matrix.tcl-version }}-${{ github.event.inputs.config }}-${{ matrix.architecture }}
        path: ${{ env.GH_BAWT_BUILDDIR }}/Release/Distribution/opt/Tcl
