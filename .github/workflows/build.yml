name: Tcl/Tk Distribution

on:
  workflow_dispatch:
    inputs:
      tcl-versions:
        required: true
        type: choice
        options:
          - '["8.6.17"]'
          - '["9.0.3"]'
          - '["8.6.17","9.0.3"]'
        default: '["9.0.3"]'
      platform:
        required: true
        type: choice
        options:
          - 'windows'
          - 'linux'
          - 'macos'
          - 'all'
      architectures:
        description: 'Target architectures'
        required: true
        type: choice
        options:
          - '["x64"]'
          - '["x86"]'
          - '["x86, x64"]'
        default: '["x86, x64"]'
      config:
        description: 'BAWT Setup file to use'
        type: choice
        required: true
        options:
          - 'Tcl_BI'
        default: 'Tcl_BI'

jobs:
  build-windows:
    if: github.event.inputs.platform == 'windows' || github.event.inputs.platform == 'all'
    runs-on: windows-latest
    strategy:
      matrix:
        architecture: ${{ fromJSON(github.event.inputs.architectures) }}
        tcl-version: ${{ fromJSON(github.event.inputs.tcl-versions) }}

    steps:
    - name: Setup BAWT environment
      shell: pwsh
      run: |
        $GH_BAWT_BUILDDIR="BawtBuild/${{ matrix.tcl-version }}/${{ github.event.inputs.config }}/Windows/${{ matrix.architecture }}"
        "GH_BAWT_BUILDDIR=$GH_BAWT_BUILDDIR" >> $env:GITHUB_ENV

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download BAWT framework
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://www.bawt.tcl3d.org/download/Framework/Bawt-3.2.0.zip" -OutFile "Bawt-3.2.0.zip"
        Expand-Archive -Path "Bawt-3.2.0.zip" -DestinationPath "." -Force
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

    - name: Download MSYS/MinGW
      shell: pwsh
      run: |
        Set-Location "Bawt-3.2.0/Bootstrap-Windows"
        Invoke-WebRequest -Uri "https://www.bawt.tcl3d.org/download/Bootstrap-Windows/gcc14.2.0_x86_64-w64-mingw32.7z" -OutFile "gcc14.2.0_x86_64-w64-mingw32.7z"
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        Set-Location "../.."

    - name: Build Tcl/Tk Distribution
      shell: cmd
      run: |
        Bawt-3.2.0\tclkit-win32-intel.exe Bawt-3.2.0\Bawt.tcl --rootdir BawtBuild/${{ matrix.tcl-version }}/${{ github.event.inputs.config }} --architecture ${{ matrix.architecture }} --compiler gcc --numjobs 4 --complete ${{ github.event.inputs.config }}.bawt --tclversion ${{ matrix.tcl-version }} --exclude ffmpeg

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-windows-${{ matrix.architecture }}
        path: ${{ env.GH_BAWT_BUILDDIR }}/Logs/

    - name: Upload distribution
      uses: actions/upload-artifact@v4
      with:
        name: tcl-distribution-windows-${{ matrix.tcl-version }} ${{ matrix.architecture }}
        path: ${{ env.GH_BAWT_BUILDDIR }}/Release/Distribution/opt/Tcl

  build-linux:
    if: github.event.inputs.platform == 'linux' || github.event.inputs.platform == 'all'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        architecture: [64]

    steps:
    - name: Checkout BAWT repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential curl p7zip-full zip \
          libx11-dev libcups2-dev libcairo2-dev libglx-dev \
          libglu1-mesa-dev libasound2-dev

    - name: Download BAWT framework
      run: |
        curl -L -o Bawt-3.2.0.zip https://www.tcl3d.org/bawt/download/Bawt-3.2.0.zip
        unzip Bawt-3.2.0.zip

    - name: Set permissions
      run: |
        cd Bawt-3.2.0
        chmod u+x Build*.sh
        chmod u+x tclkit*

    - name: Build Tcl/Tk Distribution
      run: |
        cd Bawt-3.2.0
        SETUP_FILE="${{ github.event.inputs.setup_file }}"
        if [ -z "$SETUP_FILE" ]; then
          SETUP_FILE="Setup/Tcl_Basic.bawt"
        fi
        ./Build-Linux.sh intel ${{ matrix.architecture }} "$SETUP_FILE" update

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-linux-${{ matrix.architecture }}
        path: BawtBuild/Linux/x${{ matrix.architecture }}/Logs/

    - name: Upload distribution
      uses: actions/upload-artifact@v4
      with:
        name: tcl-distribution-linux-${{ matrix.architecture }}
        path: BawtBuild/Linux/x${{ matrix.architecture }}/Release/Distribution/

  build-macos:
    if: github.event.inputs.platform == 'macos' || github.event.inputs.platform == 'all'
    runs-on: macos-latest

    steps:
    - name: Checkout BAWT repository
      uses: actions/checkout@v4

    - name: Install XCode Command Line Tools
      run: |
        xcode-select --install 2>/dev/null || true

    - name: Download BAWT framework
      run: |
        curl -L -o Bawt-3.2.0.zip https://www.tcl3d.org/bawt/download/Bawt-3.2.0.zip
        unzip Bawt-3.2.0.zip

    - name: Set permissions
      run: |
        cd Bawt-3.2.0
        chmod u+x Build*.sh
        chmod u+x tclkit*

    - name: Build Tcl/Tk Distribution
      run: |
        cd Bawt-3.2.0
        SETUP_FILE="${{ github.event.inputs.setup_file }}"
        if [ -z "$SETUP_FILE" ]; then
          SETUP_FILE="Setup/Tcl_Basic.bawt"
        fi
        ./Build-Darwin.sh universal "$SETUP_FILE" update

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-macos
        path: BawtBuild/Darwin/x64/Logs/

    - name: Upload distribution
      uses: actions/upload-artifact@v4
      with:
        name: tcl-distribution-macos
        path: BawtBuild/Darwin/x64/Release/Distribution/